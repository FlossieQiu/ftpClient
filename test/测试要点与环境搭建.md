
# 环境搭建

### 搭建本地 FTP 测试服务器

为了测试 FTP 插件的上传、下载、断点续传及中文路径支持能力，我们需要搭建一个轻量级的标准 FTP 服务器。这里使用 Python 的 pyftpdlib 库来实现。

1. 安装 Python 环境
确保本地已安装 Python 3.x 环境（推荐 3.6 以上版本）。
2. 安装依赖库
通过 pip 安装 pyftpdlib：
```
pip install pyftpdlib
```
3. 准备 FTP 服务端脚本
在测试目录下复制粘贴一个名为 server_ftp.py 的文件。该脚本将启动一个监听 2121 端口的 FTP 服务器，并配置用户权限及中文编码支持。

4. 启动 FTP 服务器
在终端或命令行中运行：
```python server_ftp.py```

注意：测试过程中请保持该终端窗口开启。



### 启动 DolphinDB，运行回归用例

确保 DolphinDB Server 已启动，并将插件文件（PluginFtpClient.txt 和 .so/.dll）放置在插件目录下。


```
loadPlugin("/path_to_kafka/bin/PluginFtpClient.txt")
go
test("/path_to_ftpClient/test/ftpClientTesting.dos","/unittest_output/ftpclienttest.txt");
```

回归用例的结果将输出到指定的文件中。



# 测试要点

本插件包含列表获取、内存上传、文件上传、目录下载（含断点续传）四大核心功能。以下列出各接口的详细测试要点。

### 1. ftpList

接口：`ftpClient::ftpList(url, [user], [password], [timeout])`

功能：列出指定目录下的文件及属性。

异常用例：

- 参数类型错误：
  - url 输入非字符串（如 int）。
  - timeout 输入非数值（如 string）。
- 参数逻辑错误：
  - url 为 NULL 或空字符串。
  - url 协议头错误（如 http://...）。
- 权限与连接：
  - 用户名或密码错误（验证 530 Login incorrect）。
  - 连接不可达的 IP 或端口（验证超时机制）。

正常用例：

- 基础功能：列出根目录或子目录，验证返回表的列结构（filename, isDir, size, lastModified）。
- 编码兼容：列出包含中文名称或空格的文件，验证文件名在 DolphinDB 表中显示是否乱码。
- 空目录：列出空目录，验证返回空表（行数为0）而非报错。
### 2. ftpUpload
接口：`ftpClient::ftpUpload(url, data, [user], [password], [timeout])`

功能：将内存数据（String/Blob）上传为远程文件。

异常用例：

- 数据为空：data 参数为 NULL（应报错，禁止创建空指针文件）。
- 路径错误：url 仅指定目录未指定文件名（如 ftp://host/dir/）。
- 权限不足：使用只读账号尝试上传（如果服务端支持配置）。

正常用例：

- 文本上传：上传普通 CSV 格式字符串。
- 二进制上传：上传 blob 类型数据。
- 覆盖上传：对已存在的文件再次上传，验证内容已被更新。
- 智能编码：url 中包含中文或空格（如 ftp://host/测试 数据.csv），验证插件是否自动转义并成功上传。
### 3. ftpUploadFile

接口：`ftpClient::ftpUploadFile(url, localFilePath, [user], [password], [timeout])`

功能：将本地磁盘文件流式上传到服务器。

异常用例：
- 本地文件不存在：localFilePath 指向不存在的路径。
- 本地路径为空：localFilePath 为 NULL 或空字符串。

正常用例：
- 常规文件：上传一个标准文本文件。
- 中文路径：
  - 本地文件名含中文（Windows下需验证 UTF-8 到 ANSI 的自动转换）。
  - 远程文件名含中文。
- 大文件模拟：上传一个稍大的文件（如 5MB），验证流式传输稳定性。
### 4. ftpDownloadDir

接口：`ftpClient::ftpDownloadDir(remoteUrl, localDir, [user], [password], [timeout])`

功能：递归下载目录或单文件，支持断点续传。

异常用例：
- 远程路径不存在：下载不存在的 URL。
- 本地目录权限：本地 localDir 无写权限（视操作系统环境而定）。

正常用例：
- 单文件下载：指定 URL 为文件，下载到本地目录。
- 递归下载：
  - 指定 URL 为目录，验证子目录结构和文件是否完整同步到本地。
- 断点续传与跳过：
  - 第一次下载：记录耗时和文件数。
  - 第二次下载：在文件未变动情况下，验证耗时极短（毫秒级），且返回的文件计数正确，验证是否触发了“跳过”逻辑。
- 编码处理：
  - 远程文件名含中文，下载到 Windows 本地后，验证文件名在资源管理器中显示正常（无乱码）。
  - URL 路径含空格（如 Program Files），验证是否能自动识别。

### 5. ftpGet 

接口：`ftpClient::ftpGet(url, [user], [password], [timeout])`

功能：将远程文件内容下载到内存（返回 String）。

异常用例：

- 参数校验：url 为 NULL、空字符串或指向一个目录（而非文件）。
- 文件不存在：请求不存在的文件名，验证是否抛出异常（如 RETR failed 或 404）。
- 认证/超时：同上。

正常用例：

- 文本内容：下载普通的 .txt 或 .csv 文件，断言返回的字符串内容与原始文件完全一致。
- 空文件：下载一个 0 字节的文件，验证返回空字符串 ""。
- 智能编码：下载路径中包含中文或空格的文件（如 ftp://host/数据 2023.txt），验证是否下载成功。
- 二进制兼容性：下载非文本文件（如小图片或 zip 头），验证返回字符串的长度（字节数）是否正确（确保 \0 未导致截断）。

### 6. 稳定性与并发测试 (通用要点)
- 并发测试：使用 submitJob 同时发起 10+ 个 ftpList 或 ftpUpload 请求，验证插件是否发生崩溃或死锁。
- 超时测试：设置极短的 timeout (如 0.001秒)，验证是否能正确抛出 Timeout 异常而非 hang 住。
- 资源泄露：多次循环调用上传下载后，观察服务器端和 DolphinDB 端的内存/文件句柄是否稳定。
